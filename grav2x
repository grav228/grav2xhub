-- Load UI Library
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/x2zu/OPEN-SOURCE-UI-ROBLOX/refs/heads/main/X2ZU%20UI%20ROBLOX%20OPEN%20SOURCE/DummyUi-leak-by-x2zu/fetching-main/Tools/Framework.luau"))()

-- Create Main Window (ИСПРАВЛЕННЫЙ Keybind)
local Window = Library:Window({
    Title = "Grav2x Hub",
    Desc = "Grav's Hub",
    Icon = 105059922903197,
    Theme = "Dark",
    Config = {
        Keybind = Enum.KeyCode.RightControl,  -- ✅ ИЗМЕНИЛ НА RightControl
        Size = UDim2.new(0, 500, 0, 400)
    },
    CloseUIButton = {
        Enabled = true,
        Text = "grav2x"
    }
})

-- Sidebar Vertical Separator
local SidebarLine = Instance.new("Frame")
SidebarLine.Size = UDim2.new(0, 1, 1, 0)
SidebarLine.Position = UDim2.new(0, 140, 0, 0)
SidebarLine.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
SidebarLine.BorderSizePixel = 0
SidebarLine.ZIndex = 5
SidebarLine.Name = "SidebarLine"
SidebarLine.Parent = game:GetService("CoreGui")

-- Таб Main
local Tab = Window:Tab({Title = "Main", Icon = "star"})

-- Hitbox кнопка
Tab:Button({
    Title = "Hitbox",
    Desc = "Tap on this to load!",
    Callback = function()
        loadstring(game:HttpGet("https://pastefy.app/ItfO0tdg/raw"))()
        Window:Notify({
            Title = "Hitbox",
            Desc = "Loaded!",
            Time = 2
        })
    end
})

-- ESP код
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ESP_ENABLED = false
local espBoxes = {}
local espGuis = {}
local charConnections = {}

local function cleanupPlayer(player)
    if espBoxes[player] then 
        pcall(function() espBoxes[player]:Destroy() end)
        espBoxes[player] = nil 
    end
    if espGuis[player] then 
        pcall(function() espGuis[player]:Destroy() end)
        espGuis[player] = nil 
    end
end

local function createESP(player)
    if player == LocalPlayer or not ESP_ENABLED then return end
    
    local function onCharacterAdded(character)
        if not ESP_ENABLED then return end
        
        cleanupPlayer(player)
        
        local hrp = character:WaitForChild("HumanoidRootPart", 10)
        local head = character:WaitForChild("Head", 10)
        local humanoid = character:WaitForChild("Humanoid", 10)
        
        if not (hrp and head and humanoid) then return end
        
        local box = Instance.new("BoxHandleAdornment")
        box.Name = "ESP_Box_" .. player.Name
        box.Adornee = hrp
        local playerHeight = humanoid.HipHeight + head.Size.Y + 1
        box.Size = Vector3.new(4, playerHeight, 2)
        box.Color3 = Color3.fromRGB(255, 0, 0)
        box.Transparency = 0.5
        box.AlwaysOnTop = true
        box.ZIndex = 10
        box.Parent = hrp
        espBoxes[player] = box
        
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "ESP_NameHealth_" .. player.Name
        billboard.Adornee = head
        billboard.Size = UDim2.new(0, 200, 0, 50)
        billboard.StudsOffset = Vector3.new(0, 2, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = head
        
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = player.Name
        nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        nameLabel.TextScaled = true
        nameLabel.Font = Enum.Font.SourceSansBold
        nameLabel.Parent = billboard
        
        local hpLabel = Instance.new("TextLabel")
        hpLabel.Size = UDim2.new(1, 0, 0.5, 0)
        hpLabel.Position = UDim2.new(0, 0, 0.5, 0)
        hpLabel.BackgroundTransparency = 1
        hpLabel.Text = "HP: " .. math.floor(humanoid.Health)
        hpLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
        hpLabel.TextScaled = true
        hpLabel.Font = Enum.Font.SourceSans
        hpLabel.Parent = billboard
        espGuis[player] = billboard
        
        humanoid.HealthChanged:Connect(function(health)
            if not ESP_ENABLED or not hpLabel.Parent then return end
            local percent = math.floor((health / humanoid.MaxHealth) * 100)
            hpLabel.Text = "HP: " .. math.floor(health) .. " (" .. percent .. "%)"
            hpLabel.TextColor3 = percent > 50 and Color3.fromRGB(0, 255, 0) or (percent > 25 and Color3.fromRGB(255, 255, 0) or Color3.fromRGB(255, 0, 0))
        end)
        
        humanoid:GetPropertyChangedSignal("HipHeight"):Connect(function()
            if not ESP_ENABLED or not box.Parent then return end
            local newHeight = humanoid.HipHeight + head.Size.Y + 1
            box.Size = Vector3.new(4, newHeight, 2)
        end)
    end
    
    if player.Character and player.Character.Parent then
        onCharacterAdded(player.Character)
    end
    
    if not charConnections[player] then
        charConnections[player] = player.CharacterAdded:Connect(function()
            task.wait(0.5)
            if ESP_ENABLED then
                onCharacterAdded(player.Character)
            end
        end)
    end
end

local function toggleESP(state)
    ESP_ENABLED = state
    if state then
        for _, player in ipairs(Players:GetPlayers()) do
            createESP(player)
        end
        Window:Notify({
            Title = "ESP",
            Desc = "On",
            Time = 2
        })
    else
        for player, _ in pairs(espBoxes) do
            cleanupPlayer(player)
        end
        espBoxes = {}
        espGuis = {}
        Window:Notify({
            Title = "ESP",
            Desc = "Off",
            Time = 2
        })
    end
end

-- ESP Toggle
Tab:Toggle({
    Title = "ESP (Box + HP + name)",
    Desc = "Red box and other",
    Value = false,
    Callback = function(v)
        toggleESP(v)
    end
})

-- Очистка
Players.PlayerRemoving:Connect(function(player)
    cleanupPlayer(player)
    charConnections[player] = nil
end)

for _, player in ipairs(Players:GetPlayers()) do
    createESP(player)
end

Window:Notify({
    Title = "grav2x",
    Desc = "GUI + ESP + Hitbox",
    Time = 3
})
